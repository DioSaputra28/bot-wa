<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WhatsApp Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .logout-btn {
            background: white;
            color: #667eea;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #666;
            font-weight: 500;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-value.online {
            color: #4caf50;
        }
        
        .status-value.qr-ready {
            color: #ff9800;
        }
        
        .status-value.connecting {
            color: #2196f3;
        }
        
        .status-value.offline {
            color: #f44336;
        }
        
        .status-value.warning {
            color: #ff9800;
        }

        .status-value.high-cpu {
            color: #f44336;
        }

        .status-value.medium-cpu {
            color: #ff9800;
        }

        .status-value.low-cpu {
            color: #4caf50;
        }

        .status-value.high-memory {
            color: #f44336;
        }

        .status-value.medium-memory {
            color: #ff9800;
        }

        .status-value.low-memory {
            color: #4caf50;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-fill {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .progress-fill.high {
            background: #f44336;
        }

        .progress-fill.medium {
            background: #ff9800;
        }

        .progress-fill.low {
            background: #4caf50;
        }

        #qrCodeImage {
            max-width: 256px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            padding: 10px;
        }
        
        #connectionStatus {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .connection-success {
            background: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }
        
        .connection-error {
            background: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
        }

        .commands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .command-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .command-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .command-syntax {
            background: #e8e8e8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            color: #555;
            overflow-x: auto;
        }

        .command-desc {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }

        .info-text {
            color: #666;
            line-height: 1.6;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>WhatsApp Bot Dashboard</h1>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="container">
        <div class="card">
            <h2>Status Bot</h2>
            <div class="status-item">
                <span class="status-label">Server Status</span>
                <span class="status-value online" id="status">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Port</span>
                <span class="status-value" id="port">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Bot Name</span>
                <span class="status-value" id="botName">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Version</span>
                <span class="status-value" id="version">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">WhatsApp Status</span>
                <span class="status-value" id="whatsappStatus">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Uptime</span>
                <span class="status-value" id="uptime">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Last Update</span>
                <span class="status-value" id="lastUpdate">Loading...</span>
            </div>
        </div>

        <div class="card">
            <h2>System Monitoring</h2>
            <div class="status-item">
                <span class="status-label">CPU Usage</span>
                <span class="status-value" id="cpuUsage">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">CPU Cores</span>
                <span class="status-value" id="cpuCores">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Memory Usage</span>
                <span class="status-value" id="memoryUsage">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Memory Total</span>
                <span class="status-value" id="memoryTotal">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Memory Free</span>
                <span class="status-value" id="memoryFree">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Process Memory</span>
                <span class="status-value" id="processMemory">Loading...</span>
            </div>
        </div>

        <div class="card">
            <h2>Network Bandwidth</h2>
            <div class="status-item">
                <span class="status-label">Upload (KB)</span>
                <span class="status-value" id="bandwidthUpload">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Download (KB)</span>
                <span class="status-value" id="bandwidthDownload">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Upload (MB)</span>
                <span class="status-value" id="bandwidthUploadMb">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Download (MB)</span>
                <span class="status-value" id="bandwidthDownloadMb">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Total Transfer</span>
                <span class="status-value" id="totalTransfer">Loading...</span>
            </div>
        </div>

        <div class="card">
            <h2>WhatsApp Connection</h2>
            <div id="connectionSection">
                <div id="qrSection" style="display: none;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">Scan QR Code dengan WhatsApp</h3>
                        <div id="qrCodeContainer" style="margin: 20px auto; max-width: 300px;">
                            <img id="qrCodeImage" alt="QR Code" style="width: 100%; border: 2px solid #ddd; border-radius: 8px;">
                            <p style="margin-top: 10px; color: #666;">QR Code akan diupdate otomatis</p>
                        </div>
                        <div style="margin-top: 20px;">
                            <button id="refreshQR" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                üîÑ Refresh QR
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="pairSection" style="display: none;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">Masukkan Pair Code</h3>
                        <div style="margin: 20px auto; max-width: 400px;">
                            <input type="tel" id="phoneNumberInput" placeholder="Nomor HP (ex: 6281234567890)" 
                                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 16px;">
                            <button id="requestPairCode" style="background: #4caf50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                üì± Request Pair Code
                            </button>
                            <div id="pairCodeResult" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <div id="connectionStatus" style="text-align: center; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <div id="connectionMessage">Memeriksa status koneksi...</div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="toggleConnection" style="background: #ff6b6b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        üîÑ Connect Method
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Perintah WhatsApp</h2>
            <div class="info-text" style="margin-bottom: 15px;">
                Gunakan perintah berikut di WhatsApp untuk mendownload media dari berbagai platform:
            </div>
            <div class="commands-grid">
                <div class="command-card">
                    <div class="command-title">TikTok</div>
                    <div class="command-syntax">.tt&lt;url_tiktok&gt;</div>
                    <div class="command-desc">Download video TikTok tanpa watermark</div>
                </div>
                <div class="command-card">
                    <div class="command-title">YouTube Video</div>
                    <div class="command-syntax">.ytmp4&lt;url_youtube&gt;</div>
                    <div class="command-desc">Download video YouTube</div>
                </div>
                <div class="command-card">
                    <div class="command-title">YouTube Audio</div>
                    <div class="command-syntax">.ytmp3&lt;url_youtube&gt;</div>
                    <div class="command-desc">Download audio YouTube sebagai MP3</div>
                </div>
                <div class="command-card">
                    <div class="command-title">Instagram</div>
                    <div class="command-syntax">.ig&lt;url_instagram&gt;</div>
                    <div class="command-desc">Download media dari Instagram</div>
                </div>
                <div class="command-card">
                    <div class="command-title">Twitter/X</div>
                    <div class="command-syntax">.twitter&lt;url_twitter&gt;</div>
                    <div class="command-desc">Download media dari Twitter/X</div>
                </div>
                <div class="command-card">
                    <div class="command-title">Facebook</div>
                    <div class="command-syntax">.fb&lt;url_facebook&gt;</div>
                    <div class="command-desc">Download video dari Facebook</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Catatan</h2>
            <div class="info-text" style="margin-bottom: 10px;">‚Ä¢ Maksimum ukuran file WhatsApp: <span class="highlight">16MB</span></div>
                <p style="margin-bottom: 10px;">‚Ä¢ File download akan disimpan sementara dan otomatis dihapus setelah dikirim</p>
                <p>‚Ä¢ Pastikan URL yang dimasukkan valid dan dapat diakses</p>
            </div>
    </div>

    <script>
        const logoutBtn = document.getElementById('logoutBtn');

        let currentConnectionMethod = 'qr';
        let eventSource = null;
        let updateInterval = null;
        let qrLoaded = false;
        let lastStatus = null;

        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Bot status
                document.getElementById('status').textContent = data.status === 'online' ? 'üü¢ Online' : data.status;
                document.getElementById('port').textContent = data.port;
                document.getElementById('botName').textContent = data.bot;
                document.getElementById('version').textContent = data.version;
                document.getElementById('uptime').textContent = formatUptime(data.uptime);
                
                // WhatsApp status
                if (data.whatsapp) {
                    updateWhatsAppStatus(data.whatsapp.status, data.whatsapp.hasQR);
                    document.getElementById('lastUpdate').textContent = new Date(data.whatsapp.timestamp).toLocaleString('id-ID');
                }

                // System stats
                if (data.system) {
                    updateSystemStats(data.system);
                }
            } catch (error) {
                console.error('Failed to load status:', error);
                document.getElementById('status').textContent = 'Error';
            }
        }

        function updateSystemStats(system) {
            // CPU
            const cpuUsage = system.cpu.usage || 0;
            document.getElementById('cpuUsage').textContent = `${cpuUsage}%`;
            document.getElementById('cpuUsage').className = `status-value ${getCPUMemoryClass(cpuUsage)}`;
            document.getElementById('cpuCores').textContent = system.cpu.cores || 0;

            // Memory
            const memUsed = system.memory.used || 0;
            const memTotal = system.memory.total || 0;
            const memPercent = Math.round((memUsed / memTotal) * 100);
            
            document.getElementById('memoryUsage').textContent = `${memUsed}MB (${memPercent}%)`;
            document.getElementById('memoryUsage').className = `status-value ${getCPUMemoryClass(memPercent)}`;
            document.getElementById('memoryTotal').textContent = `${memTotal}MB`;
            document.getElementById('memoryFree').textContent = `${system.memory.free || 0}MB`;
            document.getElementById('processMemory').textContent = `${system.memory.process.rss || 0}MB`;

            // Bandwidth
            document.getElementById('bandwidthUpload').textContent = `${system.bandwidth.upload || 0} KB`;
            document.getElementById('bandwidthDownload').textContent = `${system.bandwidth.download || 0} KB`;
            document.getElementById('bandwidthUploadMb').textContent = `${system.bandwidth.uploadMb || 0} MB`;
            document.getElementById('bandwidthDownloadMb').textContent = `${system.bandwidth.downloadMb || 0} MB`;
            
            const totalMb = (system.bandwidth.uploadMb || 0) + (system.bandwidth.downloadMb || 0);
            document.getElementById('totalTransfer').textContent = `${totalMb.toFixed(2)} MB`;
        }

        function getCPUMemoryClass(percentage) {
            if (percentage >= 80) return 'high-cpu';
            if (percentage >= 60) return 'medium-cpu';
            return 'low-cpu';
        }

        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                return `${days}d ${hours % 24}h ${minutes % 60}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function updateWhatsAppStatus(status, hasQR) {
            const statusElement = document.getElementById('whatsappStatus');
            const connectionMessage = document.getElementById('connectionMessage');

            statusElement.textContent = getStatusDisplay(status);
            statusElement.className = 'status-value ' + getStatusClass(status);

            // Reset QR loaded flag when status actually changes to a state that needs new QR
            if (status !== lastStatus && (status === 'qr-ready' || status === 'disconnected' || status === 'needs-scan')) {
                qrLoaded = false;
            }
            lastStatus = status;

            switch (status) {
                case 'qr-ready':
                    showQRSection();
                    connectionMessage.innerHTML = 'üì± Scan QR Code untuk menghubungkan WhatsApp';
                    break;
                case 'connecting':
                    connectionMessage.innerHTML = 'üîÑ Menghubungkan ke WhatsApp...';
                    break;
                case 'connected':
                    connectionMessage.innerHTML = '‚úÖ WhatsApp terhubung!';
                    hideConnectionSection();
                    break;
                case 'disconnected':
                    connectionMessage.innerHTML = '‚ùå WhatsApp terputus. Menunggu QR Code baru...';
                    break;
                case 'needs-scan':
                    connectionMessage.innerHTML = 'üì± Silakan scan QR Code kembali';
                    break;
                default:
                    connectionMessage.innerHTML = status || 'Status tidak diketahui';
            }
        }

        function getStatusDisplay(status) {
            const statusMap = {
                'qr-ready': 'üì± QR Ready',
                'connecting': 'üîÑ Connecting',
                'connected': '‚úÖ Connected',
                'disconnected': '‚ùå Disconnected',
                'needs-scan': 'üì± Needs Scan'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'qr-ready': 'qr-ready',
                'connecting': 'connecting',
                'connected': 'online',
                'disconnected': 'offline',
                'needs-scan': 'warning'
            };
            return classMap[status] || '';
        }

        function showQRSection() {
            document.getElementById('qrSection').style.display = currentConnectionMethod === 'qr' ? 'block' : 'none';
            document.getElementById('pairSection').style.display = currentConnectionMethod === 'pair' ? 'block' : 'none';
            document.getElementById('connectionSection').style.display = 'block';
            if (currentConnectionMethod === 'qr' && !qrLoaded) {
                loadQRCode();
            }
        }

        function showPairSection() {
            document.getElementById('qrSection').style.display = 'none';
            document.getElementById('pairSection').style.display = currentConnectionMethod === 'pair' ? 'block' : 'none';
            document.getElementById('connectionSection').style.display = 'block';
        }

        function hideConnectionSection() {
            document.getElementById('connectionSection').style.display = 'none';
        }

        async function loadQRCode() {
            if (currentConnectionMethod !== 'qr') return;

            try {
                const response = await fetch('/api/qr');
                const data = await response.json();

                if (data.success && data.qrCode) {
                    document.getElementById('qrCodeImage').src = `/api/qr/image?${Date.now()}`;
                    updateWhatsAppStatus(data.status, true);
                    qrLoaded = true;
                }
            } catch (error) {
                console.error('Failed to load QR code:', error);
                document.getElementById('qrCodeImage').alt = 'Failed to load QR code';
            }
        }

        function toggleConnectionMethod() {
            currentConnectionMethod = currentConnectionMethod === 'qr' ? 'pair' : 'qr';
            document.getElementById('toggleConnection').textContent = currentConnectionMethod === 'qr' ? 'üîÑ Connect Method' : 'üîÑ Switch to QR';
            
            if (currentConnectionMethod === 'qr') {
                showQRSection();
            } else {
                showPairSection();
            }
        }

        async function requestPairCode() {
            const phoneNumber = document.getElementById('phoneNumberInput').value;
            const resultDiv = document.getElementById('pairCodeResult');
            
            if (!phoneNumber) {
                resultDiv.innerHTML = '<div style="background: #ffebee; color: #c62828;">‚ùå Masukkan nomor HP</div>';
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/pair-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #e8f5e8; color: #2e7d32;">
                            <strong>Pair Code: ${data.pairCode}</strong><br>
                            <small>Masukkan code ini di WhatsApp: Settings > Linked Devices > Link Device</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="background: #ffebee; color: #c62828;">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<div style="background: #ffebee; color: #c62828;">‚ùå Gagal meminta pair code</div>';
            }
            
            resultDiv.style.display = 'block';
        }

        function startRealTimeUpdates() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/api/events');
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'status-update') {
                        updateWhatsAppStatus(data.status, data.hasQR);
                        document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleString('id-ID');

                        // Only load QR code once when it becomes available
                        if (data.status === 'qr-ready' && data.hasQR && currentConnectionMethod === 'qr' && !qrLoaded) {
                            loadQRCode();
                        }
                    }
                } catch (error) {
                    console.error('Error processing event:', error);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('EventSource error:', event);
                eventSource.close();
                
                setTimeout(() => {
                    startRealTimeUpdates();
                }, 5000);
            };
        }

        logoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout failed:', error);
            }
        });

        document.getElementById('toggleConnection').addEventListener('click', toggleConnectionMethod);
        document.getElementById('refreshQR').addEventListener('click', () => {
            qrLoaded = false;
            loadQRCode();
        });
        document.getElementById('requestPairCode').addEventListener('click', requestPairCode);
        document.getElementById('phoneNumberInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                requestPairCode();
            }
        });

        loadStatus();
        startRealTimeUpdates();
    </script>
</body>
</html>